

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darlehenstilgungsrechner (Startmonat + flexible Rate)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .content { padding: 30px; }
        .input-section { background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        .input-section h2 { color: #667eea; margin-bottom: 20px; font-size: 20px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px; }
        .input-group input { padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: border-color 0.3s; }
        .input-group input:focus { outline: none; border-color: #667eea; }
        .hint { font-size: 12px; color: #666; margin-top: 3px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 20px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .info-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; }
        .info-card h3 { font-size: 14px; opacity: 0.9; margin-bottom: 10px; }
        .info-card p { font-size: 22px; font-weight: 700; }
        .table-container { overflow-x: auto; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        th { padding: 12px; text-align: left; font-weight: 600; font-size: 13px; }
        td { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        tbody tr:hover { background: #f8f9fa; }
        tbody tr.paid { background: #d4edda; }
        .sondertilgung-input, .rate-input { width: 100px; padding: 4px 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 12px; }
        .sondertilgung-input:focus, .rate-input:focus { outline: none; border-color: #667eea; }
        @media (max-width: 768px) { .content { padding: 15px; } .input-section { padding: 15px; } .header h1 { font-size: 22px; } table { font-size: 11px; } th, td { padding: 6px; } }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ðŸ’° Darlehenstilgungsrechner</h1>
        <p>Startmonat der Tilgung wÃ¤hlbar, Rate und Sondertilgung je Monat anpassbar</p>
    </div>

    <div class="content">
        <div class="input-section">
            <h2>Eingabeparameter</h2>
            <div class="input-grid">
                <div class="input-group">
                    <label for="darlehen">Darlehenssumme (â‚¬)</label>
                    <input type="number" id="darlehen" value="20000" step="100">
                </div>
                <div class="input-group">
                    <label for="zinssatz">Zinssatz (% pro Jahr)</label>
                    <input type="number" id="zinssatz" value="3.0" step="0.1">
                </div>
                <div class="input-group">
                    <label for="rate">Standard-Monatsrate (â‚¬)</label>
                    <input type="number" id="rate" value="350" step="10">
                    <span class="hint">Wird als Vorgabe fÃ¼r alle Monate verwendet, kann unten je Monat angepasst werden.</span>
                </div>
                <div class="input-group">
                    <label for="startmonat">Beginn der Tilgung</label>
                    <input type="month" id="startmonat">
                    <span class="hint">Monat/Jahr, ab dem die erste Rate gezahlt wird. Leer lassen = nÃ¤chster Monat.</span>
                </div>
            </div>
            <button class="btn" onclick="berechnen()">ðŸ“Š Tilgungsplan berechnen</button>
        </div>

        <div class="info-section" id="infoSection" style="display:none;">
            <div class="info-card"><h3>Gesamtzinsen</h3><p id="gesamtzinsen">-</p></div>
            <div class="info-card"><h3>Laufzeit</h3><p id="laufzeit">-</p></div>
            <div class="info-card"><h3>Gesamtkosten</h3><p id="gesamtkosten">-</p></div>
        </div>

        <div class="table-container" id="tableContainer" style="display:none;">
            <table>
                <thead>
                    <tr>
                        <th>Monat</th>
                        <th>Restschuld Anfang</th>
                        <th>Monatsrate</th>
                        <th>Zinsanteil</th>
                        <th>Tilgungsanteil</th>
                        <th>Sondertilgung</th>
                        <th>Restschuld Ende</th>
                    </tr>
                </thead>
                <tbody id="tilgungsTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let tilgungsdaten = [];

async function loadPlan() {
    try {
        const res = await fetch('/api/plan');
        if (!res.ok) throw new Error('no plan');
        const data = await res.json();
        if (!data || !data.tilgungsdaten) throw new Error('empty');

        // Eingaben Ã¼bernehmen
        document.getElementById('darlehen').value = data.darlehen;
        document.getElementById('zinssatz').value = data.zinssatz;
        document.getElementById('rate').value = data.standardRate;
        if (data.startmonat) {
            document.getElementById('startmonat').value = data.startmonat;
        }

        // Tilgungsdaten Ã¼bernehmen - WICHTIG: Datum-Strings zu Date konvertieren
        tilgungsdaten = data.tilgungsdaten.map(zeile => ({
            ...zeile,
            datum: new Date(zeile.datum)  // String zurÃ¼ck zu Date konvertieren
        }));

        document.getElementById('infoSection').style.display = 'grid';
        document.getElementById('tableContainer').style.display = 'block';
        aktualisiereTilgungsplan();
        aktualiziereInfo();
    } catch (e) {
        console.error('Plan konnte nicht geladen werden, berechne neu', e);
        berechnen();
    }
}

async function savePlan() {
    const payload = {
        darlehen: parseFloat(document.getElementById('darlehen').value),
        zinssatz: parseFloat(document.getElementById('zinssatz').value),
        standardRate: parseFloat(document.getElementById('rate').value),
        startmonat: document.getElementById('startmonat').value,
        tilgungsdaten: tilgungsdaten
    };

    try {
        await fetch('/api/plan', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        console.log('Plan gespeichert');
    } catch (e) {
        console.error('Plan konnte nicht gespeichert werden', e);
    }
}

function berechnen() {
    const darlehen = parseFloat(document.getElementById('darlehen').value);
    const zinssatzJahr = parseFloat(document.getElementById('zinssatz').value);
    const standardRate = parseFloat(document.getElementById('rate').value);

    if (isNaN(darlehen) || isNaN(zinssatzJahr) || isNaN(standardRate)) {
        alert('Bitte geben Sie gÃ¼ltige Werte ein!');
        return;
    }

    // Startmonat bestimmen
    const startmonatInput = document.getElementById('startmonat').value;
    let startDatum;
    if (startmonatInput) {
        const [jahr, monat] = startmonatInput.split('-').map(Number);
        startDatum = new Date(jahr, monat - 1, 1);
    } else {
        startDatum = new Date();
        startDatum.setMonth(startDatum.getMonth() + 1);
        startDatum.setDate(1);
    }

    tilgungsdaten = [];
    let restschuld = darlehen;
    let monat = 0;

    while (restschuld > 0.01 && monat < 600) {
        const datum = new Date(startDatum);
        datum.setMonth(datum.getMonth() + monat);

        const monatszins = (zinssatzJahr / 100 / 12) * restschuld;
        const geplanteRate = standardRate;
        const rateMax = restschuld + monatszins;
        const tatsaechlicheRate = Math.min(geplanteRate, rateMax);
        const tilgung = Math.max(0, tatsaechlicheRate - monatszins);
        const neueRestschuld = Math.max(0, restschuld - tilgung);

        tilgungsdaten.push({
            monat: monat + 1,
            datum: datum,
            restschuldAnfang: restschuld,
            rate: tatsaechlicheRate,
            geplanteRate: geplanteRate,
            zins: monatszins,
            tilgung: tilgung,
            sondertilgung: 0,
            restschuldEnde: neueRestschuld
        });

        restschuld = neueRestschuld;
        monat++;
    }

    document.getElementById('infoSection').style.display = 'grid';
    aktualisiereTilgungsplan();
    aktualiziereInfo();
    document.getElementById('tableContainer').style.display = 'block';
    savePlan();
}

function aktualisiereTilgungsplan() {
    const tbody = document.getElementById('tilgungsTableBody');
    tbody.innerHTML = '';

    tilgungsdaten.forEach((zeile, index) => {
        const tr = document.createElement('tr');
        if (zeile.restschuldEnde <= 0.01) tr.className = 'paid';

        tr.innerHTML = `
            <td>${formatDatum(zeile.datum)}</td>
            <td>${formatGeld(zeile.restschuldAnfang)}</td>
            <td><input type="number" class="rate-input" value="${zeile.geplanteRate.toFixed(2)}" 
                   onchange="rateAendern(${index}, this.value)" step="10" min="0"></td>
            <td>${formatGeld(zeile.zins)}</td>
            <td>${formatGeld(zeile.tilgung)}</td>
            <td><input type="number" class="sondertilgung-input" value="${zeile.sondertilgung}" 
                   onchange="sondertilgungAendern(${index}, this.value)" step="100" min="0"></td>
            <td><strong>${formatGeld(zeile.restschuldEnde)}</strong></td>
        `;
        tbody.appendChild(tr);
    });
}

function rateAendern(index, wert) {
    const neueGeplanteRate = Math.max(0, parseFloat(wert) || 0);
    tilgungsdaten[index].geplanteRate = neueGeplanteRate;
    neuberechnenAbMonat(index);
    aktualisiereTilgungsplan();
    aktualiziereInfo();
    savePlan();
}

function sondertilgungAendern(index, wert) {
    const sondertilgung = Math.max(0, parseFloat(wert) || 0);
    tilgungsdaten[index].sondertilgung = sondertilgung;
    neuberechnenAbMonat(index);
    aktualisiereTilgungsplan();
    aktualiziereInfo();
    savePlan();
}

function neuberechnenAbMonat(startIndex) {
    const zinssatzJahr = parseFloat(document.getElementById('zinssatz').value);
    const fallbackStandardRate = parseFloat(document.getElementById('rate').value);

    for (let i = startIndex; i < tilgungsdaten.length; i++) {
        const vorherRestschuld = i === 0 ? tilgungsdaten[0].restschuldAnfang : tilgungsdaten[i - 1].restschuldEnde;
        if (vorherRestschuld <= 0.01) {
            tilgungsdaten = tilgungsdaten.slice(0, i);
            break;
        }

        tilgungsdaten[i].restschuldAnfang = vorherRestschuld;
        const monatszins = (zinssatzJahr / 100 / 12) * vorherRestschuld;
        const geplanteRate = typeof tilgungsdaten[i].geplanteRate === 'number' ? tilgungsdaten[i].geplanteRate : fallbackStandardRate;
        const rateMax = vorherRestschuld + monatszins;
        const tatsaechlicheRate = Math.min(geplanteRate, rateMax);
        const tilgung = Math.max(0, tatsaechlicheRate - monatszins);

        tilgungsdaten[i].rate = tatsaechlicheRate;
        tilgungsdaten[i].zins = monatszins;
        tilgungsdaten[i].tilgung = tilgung;
        tilgungsdaten[i].restschuldEnde = Math.max(0, vorherRestschuld - tilgung - (tilgungsdaten[i].sondertilgung || 0));
    }
}

function aktualiziereInfo() {
    let gesamtzinsen = 0;
    let laufzeit = 0;

    tilgungsdaten.forEach(zeile => {
        gesamtzinsen += zeile.zins;
        if (zeile.restschuldEnde > 0.01) laufzeit = zeile.monat;
    });

    const darlehen = parseFloat(document.getElementById('darlehen').value);
    document.getElementById('gesamtzinsen').textContent = formatGeld(gesamtzinsen);
    document.getElementById('laufzeit').textContent = (laufzeit + 1) + ' Monate';
    document.getElementById('gesamtkosten').textContent = formatGeld(darlehen + gesamtzinsen);
}

function formatGeld(betrag) {
    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(betrag);
}

function formatDatum(datum) {
    return datum.toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit' });
}

window.onload = function() {
    // Standard-Startmonat vorbelegen
    const heute = new Date();
    heute.setMonth(heute.getMonth() + 1);
    const y = heute.getFullYear();
    const m = String(heute.getMonth() + 1).padStart(2, '0');
    document.getElementById('startmonat').value = y + '-' + m;
    
    // Versuche gespeicherten Plan zu laden
    loadPlan();
};
</script>
</body>
</html>
